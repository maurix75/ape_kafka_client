import json
import threading
import time
from ape_consumer import ApeConsumer
from ape_producer import ApeProducer

def process_ape_document(file_path: str) -> dict:
    """Process APE document and remove duplicates"""
    seen_fields = {}
    with open(file_path, 'r', encoding='utf-8') as f:
        for line in f:
            field = json.loads(line)
            seen_fields[field['label']] = field['value']
    return seen_fields

def producer_job(file_path: str):
    try:
        # Initialize producer
        producer = ApeProducer()
        
        # Process and send APE document
        ape_data = process_ape_document(file_path)
        
        # Use filename as key
        key = file_path.split('/')[-1].replace('_fields.json', '')
        
        # Produce message
        producer.produce_message(key, ape_data)
        producer.flush()
        print(f"Successfully produced APE document with key: {key}")
        
    except Exception as e:
        print(f"Error in producer: {str(e)}")
    finally:
        if producer:
            producer.flush()

def consumer_job():
    try:
        # Initialize consumer
        consumer = ApeConsumer()
        
        # Start consuming messages
        print("Starting consumer...")
        consumer.start_consuming()
        
    except KeyboardInterrupt:
        print("Stopping consumer...")
        consumer.stop()
    except Exception as e:
        print(f"Error in consumer: {str(e)}")

def main():
    # Start consumer in a separate thread
    consumer_thread = threading.Thread(target=consumer_job)
    consumer_thread.daemon = True
    consumer_thread.start()
    
    # Give consumer time to initialize
    time.sleep(2)
    
    # Process and produce APE document
    file_path = "/home/maurix/VSCodeProjects/ape/ape_azure_extractor/tests/output/32888643_fields.json"
    producer_job(file_path)
    
    # Keep main thread running
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        print("Shutting down...")

if __name__ == "__main__":
    main()